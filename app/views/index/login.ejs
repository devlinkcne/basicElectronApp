<!doctype html>
<html lang="en">

<head>

</head>

<body>

    <div class="splash-container">
        <div class="centeredX">
            <form id="formURL">
                <h1 id="result">Posicione o QRCode no Local indicado</h1>
                <img id="img" src="http://s.glbimg.com/jo/g1/f/original/2011/05/17/qrcode.jpg">
                </br></br>
                <input id="nfce" type="text">
                <button type="submit" class="invisible">Enviar</button>
            </form>
        </div>
    </div>

</body>

<style>
    .invisible {
        display: none;
    }

    .centeredX {
        text-align: center;
    }
</style>

<script>

    var okNFCE = "Saída Liberada";
    var waitNFCE = "Posicione o QRCode no Local indicado"
    var wrongNFCE = "Nota Fiscal Não Permitida";
    var usedNFCE = "Nota Fiscal Já Utilizada";

    document.getElementById("formURL").addEventListener("submit", function (e) {

        e.preventDefault();
        var nfce = document.getElementById("nfce").value;

        var xhttp = new XMLHttpRequest();
        xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {

            if (this.readyState == 4 && this.status == 200) {

                var dadosURL = JSON.parse(this.responseText);

                var xhttp2 = new XMLHttpRequest();
                xhttp2 = new XMLHttpRequest();

                xhttp2.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {

                        var affiliates = JSON.parse(this.responseText);

                        var xhttp3 = new XMLHttpRequest();
                        xhttp3 = new XMLHttpRequest();

                        xhttp3.onreadystatechange = function () {
                            if (this.readyState == 4 && this.status == 200) {
                                var usedDocuments = JSON.parse(this.responseText);

                                var affiliate = false;
                                var NFCE = false;
                                var checkCNPJ = false;
                                var checkNFCE = false;

                                affiliates.forEach(element => {
                                    if (dadosURL.cnpj == element.cnpj) {
                                        checkCNPJ = true;
                                        affiliate = element;
                                    }
                                });

                                usedDocuments.forEach(element => {
                                    if (dadosURL.nfce == element.nfce) {
                                        checkNFCE = true;
                                        NFCE = element;
                                    }
                                });

                                NFCE = dadosURL.nfce;

                                if (checkCNPJ == false && checkNFCE == false) {
                                    cleanInputNFCE();
                                    document.getElementById("result").innerHTML = wrongNFCE;
                                } else if (checkCNPJ == false && checkNFCE == true) {
                                    cleanInputNFCE();
                                    document.getElementById("result").innerHTML = wrongNFCE;
                                } else if (checkCNPJ == true && checkNFCE == true) {
                                    cleanInputNFCE();
                                    document.getElementById("result").innerHTML = usedNFCE;
                                } else if (checkCNPJ == true && checkNFCE == false) {

                                    var xhttp4 = new XMLHttpRequest();
                                    xhttp4 = new XMLHttpRequest();
                                    var document_type = "AFF";

                                    xhttp4.onreadystatechange = function () {
                                        if (this.readyState == 4 && this.status == 200) {
                                            var doc = JSON.parse(this.responseText);
                                            console.log(doc);
                                            console.log(affiliate);
                                            cleanInputNFCE();
                                            document.getElementById("result").innerHTML = okNFCE;
                                        }
                                    }

                                    var url = `http://localhost:3000/document`;
                                    xhttp4.open("POST", url, true);
                                    xhttp4.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                                    xhttp4.send(`document_type=${document_type}&nfce=${NFCE}`);

                                }

                                setTimeout(function () {
                                    document.getElementById("result").innerHTML = waitNFCE;
                                }, 4000);

                            }

                        }

                        var url = `http://localhost:3000/document_Affiliates`;
                        xhttp3.open("GET", url, true);
                        xhttp3.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                        xhttp3.send();

                    };
                }

                var url = `http://localhost:3000/affiliate`;
                xhttp2.open("GET", url, true);
                xhttp2.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhttp2.send();

            };

        }

        var url = `http://localhost:5000/url`;
        xhttp.open("POST", url, true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhttp.send(`url=${nfce}`);

    });

    function cleanInputNFCE() {
        document.getElementById("nfce").value = "";
        document.getElementById("nfce").focus();
    }

    document.addEventListener("click", function (e) {
        document.getElementById("nfce").focus();
    });

    window.onload = function () {
        document.getElementById("nfce").focus();
    }

</script>

</html>